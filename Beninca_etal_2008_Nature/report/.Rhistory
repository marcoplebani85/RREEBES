freq.est <- spec %>% group_by(group) %>% mutate(max_spec = max(spec), freq = freq)
freq.est <- subset(freq.est, max_spec==spec, select=c(freq,group))
freq.est$freq <- 1/freq.est$freq
freq.est
# Welch's periodogram
wspectra <- final %>% group_by(variable) %>% do(spectra = pwelch(ts(data=.$y, end=2650.15, deltat=3.35), window=5, method="pgram", plot=F))
wspec <- wspectra %>% do(data.frame(spec = .$spec[[2]], freq = .$spec[[1]], group = .[[1]]))
ggplot(wspec, aes(y=spec, x=1/freq, group=group)) + geom_line() + facet_wrap(~group) +
coord_cartesian(ylim=c(0.1,100), xlim=c(0,240))+
scale_y_continuous(trans="log")
freq.est <- wspec %>% group_by(group) %>% mutate(max_spec = max(spec), freq = freq)
freq.est <- subset(freq.est, max_spec==spec, select=c(freq,group))
freq.est$freq <- 1/freq.est$freq
frequency(final$y)
ts <- as.ts(final$y, frequency = 0.3)
#time(ts)
nuts <- read.csv(text=getURL("https://raw.githubusercontent.com/opetchey/RREEBES/master/Beninca_etal_2008_Nature/data/nutrients_original.csv"), skip=7, header=T)
nuts <- select(nuts, -X, -X.1)
nuts <- nuts[-349:-8163,]
nuts$Date <- dmy(nuts$Date)
nuts <- select(nuts, -NO2, -NO3, -NH4)
nuts$Date[duplicated(nuts$Date)]
which(duplicated(nuts$Date))
nuts <- gather(nuts, "variable", "value", 3:4)
str(nuts)
tt <- data.frame(variable=unique(all.data$variable),
Type=c("Cyclopoids", "Herbivore", "Herbivore", "Herbivore",
"Phytoplankton",  "Phytoplankton", "Phytoplankton",
"Detritivore", "Detritivore", "Bacteria", "Nutrient", "Nutrient"))
tt
an2 <- filter(all.data, Type=="Cyclopoids" & value<0.6 |
Type=="Herbivore" & value<13 |
Type=="Phytoplankton" & value<1400 |
Type=="Nutrient" & value<50 |
Type=="Bacteria" & value<10 |
Type=="Detritivore" & value<0.7)
g1 <- qplot(as.numeric(Day.number), value, col=variable, data=an2) +
facet_wrap(~Type, ncol=2, scales="free_y") +
geom_point() + geom_line() +
scale_colour_manual(values = species.colour.mapping)
g1
all.data1 <- na.omit(all.data)
mt <- plyr::dlply(all.data1,
"variable",
function(xx) pracma::interp1(x=xx$Day.number,
y=xx$value,
xi=xout,
method="cubic"))
## Aside: the duplicated date that was previously fixed was ponly discovered by a warning message
## given by the pracma::interp1 function!!!
mt <- as.data.frame(mt)
mt <- cbind(Day.number=xout, mt)
mt <- gather(mt, variable, value, 2:13)
#ggplot(mt, aes(x=Day.number, y=value)) + facet_wrap(~variable, scales="free") + geom_line()
glimpse(final)
g1 <- ggplot(filter(final, variable==soi), aes(x=Day.number, y=y)) +
facet_wrap(~variable, ncol=2, scales="free_y") +
geom_point(size=0.5, col="black") + geom_line(size=0.1) +
scale_colour_manual(values = species.colour.mapping) + ggtitle("Detrended and normalised")
g1
spp.abund$Day.number <- 1+as.numeric((spp.abund$Date - spp.abund$Date[1]) / 24 / 60 / 60)
g1 <- qplot(as.numeric(Day.number), value^0.25, col=variable, data=all.data) +
facet_wrap(~Type, ncol=2, scales="free_y") +
geom_point() + geom_line() +
scale_colour_manual(values = species.colour.mapping)
g1
g1 <- ggplot(filter(all.data, variable==soi), aes(x=Day.number, y=value)) +
facet_wrap(~variable, ncol=2, scales="free_y") +
geom_point(size=1, col="black") + geom_line(size=0.1) +
scale_colour_manual(values = species.colour.mapping) + ggtitle("Raw and interpolated data")
g2 <- geom_line(data=filter(mt, variable==soi), aes(x=Day.number, y=value), size=0.25, col="blue")
g1 + g2
all.data <- filter(all.data, Date>dmy("16/06/2091") & Date<dmy("20/10/2097"))
detrended <- group_by(mt, variable) %>%
mutate(smoothed=ksmooth(Day.number, fr.value, kernel="normal", bandwidth=300)$y)
detrended$dt.value <- detrended$value - detrended$smoothed
species.colour.mapping <- c("Cyclopoids"="pink",
"Calanoid.copepods"="red",
"Rotifers"="blue",
"Protozoa"="green",
"Nanophytoplankton"="red",
"Picophytoplankton"="black",
"Filamentous.diatoms"="green",
"Ostracods"="lightblue",
"Harpacticoids"="purple",
"Bacteria"="black",
"Total.dissolved.inorganic.nitrogen"="red",
"Soluble.reactive.phosphorus"="black")
#final_nozeros <- final[final$y!=0,]
# just removing all zeros may mess things up! Replacing them with NA's may be better:
final_nozeros <- final
final_nozeros$y <- ifelse(final_nozeros$y!=0, final_nozeros$y, NA)
# make it wide format
#library(tidyr)
final_long <- final_nozeros[final_nozeros$variable!="Cyclopoids" & final_nozeros$variable!="Filamentous.diatoms",c(1,2,7)]
final_wide <- spread(final_long, variable,y)
# we also removed data on Cyclopoids, not used in the table
source('~/.active-rstudio-document', echo=TRUE)
table1
cor.cp
cor.cp
source('~/.active-rstudio-document', echo=TRUE)
colnames(cor.cp)
colnames(cor.cp)==rownames(cor.cp)
class(cor.cp)
cor.cp <- as.data.frame(cor.cp)
cor.cp
colnames(cor.cp)
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
colnames(cor.cp)<-rownames(cor.cp)
cor.cp <- cor.cp[,c("Bacteria","Harpacticoid.copepods","Ostracods","Nitrogen",
"Phosphorus","Picophytoplankton","Nanophytoplankton","Rotifers","Protozoa","Calanoid.copepods")]
cor.cp <- as.data.frame(cor.cp)
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
colnames(cor.cp)<-rownames(cor.cp)
cor.cp <- cor.cp[,c("Bacteria","Harpacticoid.copepods","Ostracods","Nitrogen",
"Phosphorus","Picophytoplankton","Nanophytoplankton","Rotifers","Protozoa","Calanoid.copepods")]
cor.cp <- cor.cp[,c(cor.cp$Bacteria,cor.cp$Harpacticoid.copepods,cor.cp$Ostracods,cor.cp$Nitrogen,
cor.cp$Phosphorus,cor.cp$Picophytoplankton,cor.cp$Nanophytoplankton,cor.cp$Rotifers,
cor.cp$Protozoa,cor.cp$Calanoid.copepods)]
cor.cp
tt <- data.frame(variable=unique(all.data$variable),
Type=c("Cyclopoids", "Herbivore", "Herbivore", "Herbivore",
"Phytoplankton",  "Phytoplankton", "Phytoplankton",
"Detritivore", "Detritivore", "Bacteria", "Nutrient", "Nutrient"))
tt
rm(list=ls())
library(tidyr)
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(RCurl)
library(pracma)
library(oce)
spp.abund <- read.csv(text=getURL("https://raw.githubusercontent.com/opetchey/RREEBES/master/Beninca_etal_2008_Nature/data/species_abundances_original.csv"), skip=7, header=T)
spp.abund <- select(spp.abund, -X, -X.1)
spp.abund <- spp.abund[-804:-920,]
str(spp.abund)
spp.abund$Protozoa <- as.numeric(str_replace(spp.abund$Protozoa, ",", "."))
spp.abund$Date <- dmy(spp.abund$Date)
spp.abund$Date[duplicated(spp.abund$Date)]
which(duplicated(spp.abund$Date))
which(spp.abund$Date==ymd("2096-10-28 UTC"))
spp.abund$Date[701] <- ymd("2096-10-26 UTC")
sum(spp.abund$Day.number == 1+as.numeric((spp.abund$Date - spp.abund$Date[1]) / 24 / 60 / 60)) == length(spp.abund$Date)
sum(spp.abund$Day.number == 1+as.numeric((spp.abund$Date - spp.abund$Date[1]) / 24 / 60 / 60)) == length(spp.abund$Date)
spp.abund <- gather(spp.abund, "variable", "value", 3:12)
str(spp.abund)
all.data <- rbind(spp.abund, nuts)
ggplot(all.data, aes(x=Day.number, y=value)) + geom_line() +
facet_wrap(~variable, scales="free_y")
species.colour.mapping <- c("Cyclopoids"="pink",
"Calanoid.copepods"="red",
"Rotifers"="blue",
"Protozoa"="green",
"Nanophytoplankton"="red",
"Picophytoplankton"="black",
"Filamentous.diatoms"="green",
"Ostracods"="lightblue",
"Harpacticoids"="purple",
"Bacteria"="black",
"Total.dissolved.inorganic.nitrogen"="red",
"Soluble.reactive.phosphorus"="black")
g1 <- qplot(as.numeric(Day.number), value, col=variable, data=all.data) +
facet_wrap(~Type, ncol=2, scales="free_y") +
geom_point() + geom_line() +
scale_colour_manual(values = species.colour.mapping)
g1
g1 <- qplot(as.numeric(Day.number), log10(value+0.00001), col=variable, data=all.data) +
facet_wrap(~Type, ncol=2, scales="free_y") +
geom_point() + geom_line() +
scale_colour_manual(values = species.colour.mapping)
g1
#aggregate(Day.number ~ variable, all.data, min)
#aggregate(Day.number ~ variable, all.data, max)
xout <- seq(342, 2651, by=3.35)
range(xout)
mt$fr.value <- mt$value^0.25
final <- group_by(detrended, variable) %>%
mutate(y=as.numeric(scale(dt.value)))
summarise(final, mean=mean(y), sd=sd(y))
soi <- "Bacteria"
g1 <- ggplot(filter(detrended, variable==soi), aes(x=Day.number, y=fr.value)) +
facet_wrap(~variable, ncol=2, scales="free_y") +
geom_point(size=0.5, col="black") + geom_line(size=0.1) +
scale_colour_manual(values = species.colour.mapping) + ggtitle("Quarter power trans. and trend")
g2 <- geom_line(data=filter(detrended, variable==soi), aes(x=Day.number, y=smoothed), size=0.25, col="blue")
g1 + g2
# Raw spectrum
spectra <- final %>% group_by(variable) %>% do(spectra = spectrum(ts(data=.$y, end=2650.15, deltat=3.35), log='no', method="pgram", detrend=F, plot=F))
spec <- spectra %>% do(data.frame(spec = .$spec[[2]], freq = .$spec[[1]], group = .[[1]]))
ggplot(spec, aes(y=spec, x=1/freq, group=group)) + geom_line() + facet_wrap(~group) +
coord_cartesian(ylim=c(0,40), xlim=c(0,240))
freq.est <- spec %>% group_by(group) %>% mutate(max_spec = max(spec), freq = freq)
freq.est <- subset(freq.est, max_spec==spec, select=c(freq,group))
freq.est$freq <- 1/freq.est$freq
freq.est
# Welch's periodogram
wspectra <- final %>% group_by(variable) %>% do(spectra = pwelch(ts(data=.$y, end=2650.15, deltat=3.35), window=5, method="pgram", plot=F))
wspec <- wspectra %>% do(data.frame(spec = .$spec[[2]], freq = .$spec[[1]], group = .[[1]]))
ggplot(wspec, aes(y=spec, x=1/freq, group=group)) + geom_line() + facet_wrap(~group) +
coord_cartesian(ylim=c(0.1,100), xlim=c(0,240))+
scale_y_continuous(trans="log")
freq.est <- wspec %>% group_by(group) %>% mutate(max_spec = max(spec), freq = freq)
freq.est <- subset(freq.est, max_spec==spec, select=c(freq,group))
freq.est$freq <- 1/freq.est$freq
frequency(final$y)
ts <- as.ts(final$y, frequency = 0.3)
#time(ts)
cor.coefs <- cor(final_wide[,c(-1)])
# https://stat.ethz.ch/pipermail/r-help/2005-July/076050.html
pn <- function(X){crossprod(!is.na(X))}
cor.prob <- function(X){
# Correlations Below Main Diagonal
# Significance Tests with Pairwise Deletion
# Above Main Diagonal
# Believe part of this came from Bill Venables
pair.SampSize <- pn(X)
above1 <- row(pair.SampSize) < col(pair.SampSize)
pair.df <- pair.SampSize[above1] - 2
R <- cor(X, use="pair")
above2 <- row(R) < col(R)
r2 <- R[above2]^2
Fstat <- (r2 * pair.df)/(1 - r2)
R[above2] <- 1 - pf(Fstat, 1, pair.df)
R
}
cor.pvals <- cor.prob(final_wide[,c(-1)])
cor.stars <- cor.pvals
cor.stars <- ifelse(cor.pvals<0.0001, "***",
ifelse(cor.pvals<0.001, "**",
ifelse(cor.pvals<0.05, "*", "")))
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(cor.cp[i,j]=="NA NA", "", cor.cp[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(i==j, "1", cor.cp[i,j])
}}
nuts <- read.csv(text=getURL("https://raw.githubusercontent.com/opetchey/RREEBES/master/Beninca_etal_2008_Nature/data/nutrients_original.csv"), skip=7, header=T)
nuts <- select(nuts, -X, -X.1)
nuts <- nuts[-349:-8163,]
nuts$Date <- dmy(nuts$Date)
nuts <- select(nuts, -NO2, -NO3, -NH4)
nuts$Date[duplicated(nuts$Date)]
which(duplicated(nuts$Date))
nuts <- gather(nuts, "variable", "value", 3:4)
str(nuts)
all.data <- merge(all.data, tt)
g1 <- qplot(as.numeric(Day.number), value^0.25, col=variable, data=all.data) +
facet_wrap(~Type, ncol=2, scales="free_y") +
geom_point() + geom_line() +
scale_colour_manual(values = species.colour.mapping)
g1
detrended <- group_by(mt, variable) %>%
mutate(smoothed=ksmooth(Day.number, fr.value, kernel="normal", bandwidth=300)$y)
detrended$dt.value <- detrended$value - detrended$smoothed
g1 <- ggplot(filter(all.data, variable==soi), aes(x=Day.number, y=value)) +
facet_wrap(~variable, ncol=2, scales="free_y") +
geom_point(size=1, col="black") + geom_line(size=0.1) +
scale_colour_manual(values = species.colour.mapping) + ggtitle("Raw and interpolated data")
g2 <- geom_line(data=filter(mt, variable==soi), aes(x=Day.number, y=value), size=0.25, col="blue")
g1 + g2
final_nozeros <- final[final$y!=0,]
# make it wide format
#library(tidyr)
final_long <- final_nozeros[final_nozeros$variable!="Cyclopoids" & final_nozeros$variable!="Filamentous.diatoms",c(1,2,7)]
final_wide <- spread(final_long, variable,y)
# we also removed data on Cyclopoids, not used in the table
for(i in 1:10){
for(j in 1:10){
cor.pvals[i,j] <- ifelse(i<j, cor.pvals[i,j], NA)
}}
spp.abund$Day.number <- 1+as.numeric((spp.abund$Date - spp.abund$Date[1]) / 24 / 60 / 60)
all.data$Type <- factor(all.data$Type, levels=c("Cyclopoids", "Herbivore", "Phytoplankton", "Nutrient",
"Bacteria", "Detritivore"))
all.data1 <- na.omit(all.data)
mt <- plyr::dlply(all.data1,
"variable",
function(xx) pracma::interp1(x=xx$Day.number,
y=xx$value,
xi=xout,
method="cubic"))
## Aside: the duplicated date that was previously fixed was ponly discovered by a warning message
## given by the pracma::interp1 function!!!
mt <- as.data.frame(mt)
mt <- cbind(Day.number=xout, mt)
mt <- gather(mt, variable, value, 2:13)
#ggplot(mt, aes(x=Day.number, y=value)) + facet_wrap(~variable, scales="free") + geom_line()
g1 <- ggplot(filter(final, variable==soi), aes(x=Day.number, y=y)) +
facet_wrap(~variable, ncol=2, scales="free_y") +
geom_point(size=0.5, col="black") + geom_line(size=0.1) +
scale_colour_manual(values = species.colour.mapping) + ggtitle("Detrended and normalised")
g1
cor.cp <- cor.coefs
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- paste(round(cor.coefs[i,j],3), cor.stars[i,j])
}}
an2 <- filter(all.data, Type=="Cyclopoids" & value<0.6 |
Type=="Herbivore" & value<13 |
Type=="Phytoplankton" & value<1400 |
Type=="Nutrient" & value<50 |
Type=="Bacteria" & value<10 |
Type=="Detritivore" & value<0.7)
g1 <- qplot(as.numeric(Day.number), value, col=variable, data=an2) +
facet_wrap(~Type, ncol=2, scales="free_y") +
geom_point() + geom_line() +
scale_colour_manual(values = species.colour.mapping)
g1
for(i in 1:10){
for(j in 1:10){
cor.coefs[i,j] <- ifelse(i<j, cor.coefs[i,j], NA)
}}
glimpse(final)
all.data <- filter(all.data, Date>dmy("16/06/2091") & Date<dmy("20/10/2097"))
source('~/.active-rstudio-document', echo=TRUE)
final_nozeros <- final[final$y!=0,]
# make it wide format
#library(tidyr)
final_long <- final_nozeros[final_nozeros$variable!="Cyclopoids" & final_nozeros$variable!="Filamentous.diatoms",c(1,2,7)]
final_wide <- spread(final_long, variable,y)
# we also removed data on Cyclopoids, not used in the table
cor.coefs <- cor(final_wide[,c(-1)])
for(i in 1:10){
for(j in 1:10){
cor.coefs[i,j] <- ifelse(i<j, cor.coefs[i,j], NA)
}}
# https://stat.ethz.ch/pipermail/r-help/2005-July/076050.html
pn <- function(X){crossprod(!is.na(X))}
cor.prob <- function(X){
# Correlations Below Main Diagonal
# Significance Tests with Pairwise Deletion
# Above Main Diagonal
# Believe part of this came from Bill Venables
pair.SampSize <- pn(X)
above1 <- row(pair.SampSize) < col(pair.SampSize)
pair.df <- pair.SampSize[above1] - 2
R <- cor(X, use="pair")
above2 <- row(R) < col(R)
r2 <- R[above2]^2
Fstat <- (r2 * pair.df)/(1 - r2)
R[above2] <- 1 - pf(Fstat, 1, pair.df)
R
}
cor.pvals <- cor.prob(final_wide[,c(-1)])
for(i in 1:10){
for(j in 1:10){
cor.pvals[i,j] <- ifelse(i<j, cor.pvals[i,j], NA)
}}
cor.stars <- cor.pvals
cor.stars <- ifelse(cor.pvals<0.0001, "***",
ifelse(cor.pvals<0.001, "**",
ifelse(cor.pvals<0.05, "*", "")))
cor.cp <- cor.coefs
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- paste(round(cor.coefs[i,j],3), cor.stars[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(cor.cp[i,j]=="NA NA", "", cor.cp[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(i==j, "1", cor.cp[i,j])
}}
cor.cp <- as.data.frame(cor.cp)
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
colnames(cor.cp)<-rownames(cor.cp)
cor.cp
class(cor.cp)
colnames(cor.cp)
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
colnames(cor.cp)
rownames(cor.cp)
colnames(cor.cp)<-rownames(cor.cp)
rownames(cor.cp)
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
rownames(cor.cp)<-colnames(cor.cp)
cor.cp <- cor.cp[,c(cor.cp$Bacteria,cor.cp$Harpacticoid.copepods,cor.cp$Ostracods,cor.cp$Nitrogen,
cor.cp$Phosphorus,cor.cp$Picophytoplankton,cor.cp$Nanophytoplankton,cor.cp$Rotifers,
cor.cp$Protozoa,cor.cp$Calanoid.copepods)]
cor.cp
source('~/.active-rstudio-document', echo=TRUE)
final_nozeros <- final[final$y!=0,]
# make it wide format
#library(tidyr)
final_long <- final_nozeros[final_nozeros$variable!="Cyclopoids" & final_nozeros$variable!="Filamentous.diatoms",c(1,2,7)]
final_wide <- spread(final_long, variable,y)
# we also removed data on Cyclopoids, not used in the table
cor.coefs <- cor(final_wide[,c(-1)])
for(i in 1:10){
for(j in 1:10){
cor.coefs[i,j] <- ifelse(i<j, cor.coefs[i,j], NA)
}}
# https://stat.ethz.ch/pipermail/r-help/2005-July/076050.html
pn <- function(X){crossprod(!is.na(X))}
cor.prob <- function(X){
# Correlations Below Main Diagonal
# Significance Tests with Pairwise Deletion
# Above Main Diagonal
# Believe part of this came from Bill Venables
pair.SampSize <- pn(X)
above1 <- row(pair.SampSize) < col(pair.SampSize)
pair.df <- pair.SampSize[above1] - 2
R <- cor(X, use="pair")
above2 <- row(R) < col(R)
r2 <- R[above2]^2
Fstat <- (r2 * pair.df)/(1 - r2)
R[above2] <- 1 - pf(Fstat, 1, pair.df)
R
}
cor.pvals <- cor.prob(final_wide[,c(-1)])
for(i in 1:10){
for(j in 1:10){
cor.pvals[i,j] <- ifelse(i<j, cor.pvals[i,j], NA)
}}
cor.stars <- cor.pvals
cor.stars <- ifelse(cor.pvals<0.0001, "***",
ifelse(cor.pvals<0.001, "**",
ifelse(cor.pvals<0.05, "*", "")))
cor.cp <- cor.coefs
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- paste(round(cor.coefs[i,j],3), cor.stars[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(cor.cp[i,j]=="NA NA", "", cor.cp[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(i==j, "1", cor.cp[i,j])
}}
cor.cp <- as.data.frame(cor.cp)
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
rownames(cor.cp)<-colnames(cor.cp)
cor.cp <- cor.cp[,c(cor.cp$Bacteria,cor.cp$Harpacticoid.copepods,cor.cp$Ostracods,cor.cp$Nitrogen,
cor.cp$Phosphorus,cor.cp$Picophytoplankton,cor.cp$Nanophytoplankton,cor.cp$Rotifers,
cor.cp$Protozoa,cor.cp$Calanoid.copepods)]
cor.cp
final_nozeros <- final[final$y!=0,]
# make it wide format
#library(tidyr)
final_long <- final_nozeros[final_nozeros$variable!="Cyclopoids" & final_nozeros$variable!="Filamentous.diatoms",c(1,2,7)]
final_wide <- spread(final_long, variable,y)
# we also removed data on Cyclopoids, not used in the table
cor.coefs <- cor(final_wide[,c(-1)])
for(i in 1:10){
for(j in 1:10){
cor.coefs[i,j] <- ifelse(i<j, cor.coefs[i,j], NA)
}}
# https://stat.ethz.ch/pipermail/r-help/2005-July/076050.html
pn <- function(X){crossprod(!is.na(X))}
cor.prob <- function(X){
# Correlations Below Main Diagonal
# Significance Tests with Pairwise Deletion
# Above Main Diagonal
# Believe part of this came from Bill Venables
pair.SampSize <- pn(X)
above1 <- row(pair.SampSize) < col(pair.SampSize)
pair.df <- pair.SampSize[above1] - 2
R <- cor(X, use="pair")
above2 <- row(R) < col(R)
r2 <- R[above2]^2
Fstat <- (r2 * pair.df)/(1 - r2)
R[above2] <- 1 - pf(Fstat, 1, pair.df)
R
}
cor.pvals <- cor.prob(final_wide[,c(-1)])
for(i in 1:10){
for(j in 1:10){
cor.pvals[i,j] <- ifelse(i<j, cor.pvals[i,j], NA)
}}
cor.stars <- cor.pvals
cor.stars <- ifelse(cor.pvals<0.0001, "***",
ifelse(cor.pvals<0.001, "**",
ifelse(cor.pvals<0.05, "*", "")))
cor.cp <- cor.coefs
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- paste(round(cor.coefs[i,j],3), cor.stars[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(cor.cp[i,j]=="NA NA", "", cor.cp[i,j])
}}
for(i in 1:10){
for(j in 1:10){
cor.cp[i,j] <- ifelse(i==j, "1", cor.cp[i,j])
}}
cor.cp
colnames(cor.cp) <- c("Calanoid.copepods","Rotifers","Protozoa","Nanophytoplankton","Picophytoplankton",
"Ostracods","Harpacticoid.copepods","Bacteria","Nitrogen","Phosphorus")
rownames(cor.cp)<-colnames(cor.cp)
cor.cp
class(cor.cp)
cor.cp <- as.data.frame(cor.cp)
class(cor.cp)
cor.cp <- cor.cp[,c(cor.cp$Bacteria,cor.cp$Harpacticoid.copepods,cor.cp$Ostracods,cor.cp$Nitrogen,
cor.cp$Phosphorus,cor.cp$Picophytoplankton,cor.cp$Nanophytoplankton,cor.cp$Rotifers,
cor.cp$Protozoa,cor.cp$Calanoid.copepods)]
cor.cp
